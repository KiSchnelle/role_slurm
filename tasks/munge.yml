---
# 1=compute, 2=database, 3=controller, 4=first controller, 5=all
- name: Add munge group
  ansible.builtin.group:
    name: munge
    gid: 1005
    state: present
    system: false

- name: Add munge user
  ansible.builtin.user:
    name: munge
    uid: 1005
    group: munge
    create_home: true
    home: "/var/lib/munge"
    shell: "/sbin/nologin "
    state: present
    system: false


- name: Install munge dependencies on CentOS 7 and 8
  ansible.builtin.yum:
    name:
      - "OpenSSL"
      - "bzip2"
      - "zlib"
      - "pkgconf"
  when: ansible_distribution|lower == 'centos'


- name: Install munge dependencies on Ubuntu 20
  ansible.builtin.apt:
    name:
      - "openssl"
      - "bzip2"
      - "zlib1g"
      - "pkgconf"
  when: ansible_distribution|lower == 'ubuntu' and ansible_distribution_major_version is version_compare('20', '==')


- name: Create munge directories.
  block: 
  - name: Create and set permissions for /etc/munge
    ansible.builtin.file:
      path: /etc/munge
      state: directory
      recurse: true
      owner: munge
      group: munge
      mode: 0700
  
  - name: Create and set permissions for /var/lib/munge
    ansible.builtin.file:
      path: /var/lib/munge
      state: directory
      recurse: true
      owner: munge
      group: munge
      mode: 0711
  
  - name: Create and set permissions for /var/log/munge
    ansible.builtin.file:
      path: /var/log/munge
      state: directory
      recurse: true
      owner: munge
      group: munge
      mode: 0700

  - name: Create and set permissions for /var/run/munge
    ansible.builtin.file:
      path: /var/run/munge
      state: directory
      recurse: true
      owner: munge
      group: munge
      mode: 0755


- name: Install munge on CentOS 7
  ansible.builtin.yum:
    name:
      - "munge"
      - "munge-libs"
      - "munge-devel"
    state: present
    update_cache: true
  when: ansible_distribution|lower == 'centos' and ansible_distribution_major_version is version_compare('7', '==')


- name: Install munge on CentOS 8
  block:
    - name: Install munge and munge-libs on CentOS 8
      ansible.builtin.yum:
        name:
          - "munge"
          - "munge-libs"
        state: present
        update_cache: true
    
    - name: Install munge-devel on CetnOS 8
      ansible.builtin.dnf:
        name: "munge-devel"
        state: present
        update_cache: true
        enablerepo: 
          - "PowerTools"
  when: ansible_distribution|lower == 'centos' and ansible_distribution_major_version is version_compare('8', '==')

    
- name: Install munge on Ubuntu 20
  ansible.builtin.apt:
    name:
      - "munge"
      - "libmunge-dev"
      - "libmunge2"
    state: present
    update_cache: true
  when: ansible_distribution|lower == 'ubuntu' and ansible_distribution_major_version is version_compare('20', '==')



- name: Create munge key.
  block:
    - name: Install rng-tools.
      ansible.builtin.package:
        name: "rng-tools"
        state: present
    
    - name: Create random
      ansible.builtin.shell: rngd -r /dev/urandom
    
    - name: Create munge key
      ansible.builtin.shell: /usr/sbin/create-munge-key -r -f
    
    - name: Copy into munge.key
      ansible.builtin.shell: 'sh -c  "dd if=/dev/urandom bs=1 count=1024 > /etc/munge/munge.key"'
  when: 4 in install_code_list


- name: Get munge.key file from serving host.
  ansible.posix.synchronize:
    src: /etc/munge/munge.key
    dest: /etc/munge/munge.key
    mode: push
  delegate_to: "{{ munge_key_host }}"
  when: 4 not in install_code_list


- name: Make sure munge key file correct permissions.
  ansible.builtin.file:
    path: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: 0400


- name: Enable munge
  ansible.builtin.systemd:
    name: munge
    state: started
    enabled: true